<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Prefix Mail</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background:#0b1020; color: #e6edf3; }
      .wrap { max-width: 860px; margin: 40px auto; padding: 0 16px; }
      .card { background: #11162a; border: 1px solid #233; border-radius: 10px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
      h1 { margin-top: 0; font-size: 22px; }
      label { display:block; margin: 10px 0 6px; color:#9fb2c7; }
      input, button, select { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #334; background:#0f1426; color:#e6edf3; }
      button { background:#2e6df6; border-color:#2e6df6; cursor:pointer; font-weight:600; }
      button:disabled { opacity:.6; cursor:not-allowed; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #223; text-align: left; padding: 10px; }
      .row { display:flex; gap: 12px; }
      .row > * { flex: 1; }
      .mt { margin-top: 16px; }
      .small { color:#8aa; font-size: 12px; }
      a { color: #9cc4ff; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Login</h1>
        <div class="row">
          <div>
            <label>Prefix</label>
            <input id="prefix" placeholder="team-sales" />
          </div>
          <div>
            <label>Password</label>
            <input id="password" placeholder="••••" type="password" />
          </div>
        </div>
        <button id="loginBtn" class="mt">Login</button>
        <div class="small mt">Enter the mailbox prefix and its password to access emails sent to prefix@yourdomain.com (plus addressing supported).</div>
      </div>

      <div class="card mt">
        <h1>Inbox</h1>
        <table>
          <thead>
            <tr><th>Date</th><th>From</th><th>Subject</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div id="detail" class="card mt" style="display:none"></div>
    </div>

    <script>
      const api = (path, opts={}) => fetch('/api' + path, { headers: { ...(opts.headers||{}), 'Content-Type':'application/json' }, ...opts }).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json();});
      let token = null;
      const rowsEl = document.getElementById('rows');
      const detailEl = document.getElementById('detail');

      document.getElementById('loginBtn').onclick = async () => {
        const prefix = document.getElementById('prefix').value.trim();
        const password = document.getElementById('password').value;
        if(!prefix||!password){ alert('Enter prefix and password'); return; }
        try {
          const res = await api('/client/login', { method:'POST', body: JSON.stringify({ prefix, password, admin_token: '' }) });
          token = res.access_token;
          await loadEmails();
        } catch(e){ alert('Login failed'); }
      };

      async function loadEmails(){
        const res = await api('/emails?limit=100', { headers: { Authorization: 'Bearer ' + token } });
        rowsEl.innerHTML = '';
        for(const m of res){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${new Date(m.received_at).toLocaleString()}</td><td>${m.sender||''}</td><td><a href="#" data-id="${m.id}">${m.subject||''}</a></td>`;
          tr.querySelector('a').onclick = async (ev) => {
            ev.preventDefault();
            const d = await api('/emails/' + m.id, { headers: { Authorization: 'Bearer ' + token } });
            detailEl.style.display = '';
            detailEl.innerHTML = `<h1>${d.subject||''}</h1><div class="small">From: ${d.sender||''}</div><div class="small">To: ${d.to_address||''}</div><pre style="white-space:pre-wrap">${(d.body_text||'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))}</pre>`;
          };
          rowsEl.appendChild(tr);
        }
      }
    </script>
  </body>
</html>
